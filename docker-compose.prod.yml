# Production deployment using pre-built image from ghcr.io
#
# Setup:
#   mkdir -p /path/to/data/secrets
#   echo "your-auth-token" > /path/to/data/secrets/auth_token
#
# Usage:
#   DATA_DIR=/path/to/data docker compose -f docker-compose.prod.yml up -d
#
# Override server/watcher name (defaults to "nas"):
#   DATA_DIR=/path/to/data NAME=synology docker compose ...

services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: monitor
      POSTGRES_PASSWORD: monitor
      POSTGRES_DB: monitor
    volumes:
      - ${DATA_DIR:?DATA_DIR is required}/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U monitor"]
      interval: 5s
      timeout: 5s
      retries: 5

  migrate:
    image: ghcr.io/jandubois/monitor:v0.1.0
    command: migrate
    environment:
      DATABASE_URL: postgres://monitor:monitor@postgres:5432/monitor?sslmode=disable
    depends_on:
      postgres:
        condition: service_healthy

  web:
    image: ghcr.io/jandubois/monitor:v0.1.0
    command: sh -c 'AUTH_TOKEN=$$(cat /secrets/auth_token) exec /app/monitor web --name=${NAME:-nas}'
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://monitor:monitor@postgres:5432/monitor?sslmode=disable
    volumes:
      - ${DATA_DIR:?DATA_DIR is required}/secrets:/secrets:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      migrate:
        condition: service_completed_successfully

  watcher:
    image: ghcr.io/jandubois/monitor:v0.1.0
    command: >
      sh -c 'AUTH_TOKEN=$$(cat /secrets/auth_token) exec /app/monitor watcher
      --name=${NAME:-nas}
      --push-url=http://web:8080
      --callback-url=http://watcher:8081'
    restart: unless-stopped
    volumes:
      - ${DATA_DIR:?DATA_DIR is required}/secrets:/secrets:ro
    depends_on:
      web:
        condition: service_healthy

